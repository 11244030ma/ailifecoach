<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WorkLife AI Coach</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Your personal AI career coach to help you get unstuck">
  <meta name="theme-color" content="#1A1A1A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WorkLife">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- App Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #FAFAFA;
      min-height: 100vh;
      display: flex;
      padding: 0;
      margin: 0;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid #E5E7EB;
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 100;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #E5E7EB;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-title {
      font-weight: 600;
      font-size: 16px;
      color: #111827;
    }

    .close-sidebar {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6B7280;
      padding: 4px;
    }

    .new-chat-btn {
      margin: 16px;
      padding: 12px;
      background: #111827;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    .new-chat-btn:hover {
      background: #1F2937;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .chat-item {
      padding: 12px 16px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .chat-item:hover {
      background: #F9FAFB;
    }

    .chat-item.active {
      background: #F3F4F6;
    }

    .chat-item-title {
      font-size: 14px;
      font-weight: 500;
      color: #111827;
      margin-bottom: 4px;
    }

    .chat-item-preview {
      font-size: 12px;
      color: #6B7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      margin-left: 0;
      transition: margin-left 0.3s ease;
    }

    .main-content.sidebar-open {
      margin-left: 280px;
    }

    .chat-container {
      width: 100%;
      max-width: 800px;
      height: 90vh;
      max-height: 900px;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      border: 1px solid #E5E7EB;
    }

    .chat-header {
      padding: 20px 24px;
      background: white;
      border-bottom: 1px solid #E5E7EB;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .menu-button {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #374151;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .menu-button:hover {
      background: #F3F4F6;
    }

    .chat-header-content h1 {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }

    .chat-header-content p {
      font-size: 14px;
      color: #6B7280;
    }

    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: white;
    }

    .message {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease-out;
      position: relative;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-user {
      align-items: flex-end;
    }

    .message-ai {
      align-items: flex-start;
    }

    .message-content {
      padding: 12px 16px;
      font-size: 16px;
      max-width: 70%;
      word-wrap: break-word;
      line-height: 1.5;
      position: relative;
    }

    .message-user .message-content {
      background: #1A1A1A;
      color: white;
      border-radius: 16px 16px 4px 16px;
    }

    .message-ai .message-content {
      background: #F3F4F6;
      color: #111827;
      border-radius: 16px 16px 16px 4px;
      border: 1px solid #E5E7EB;
      max-width: 75%;
    }

    .message-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .message:hover .message-actions {
      opacity: 1;
    }

    .action-btn {
      background: white;
      border: 1px solid #E5E7EB;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .action-btn:hover {
      background: #F3F4F6;
      border-color: #D1D5DB;
    }

    .action-btn.copied {
      background: #ECFDF5;
      border-color: #059669;
      color: #059669;
    }

    .message-timestamp {
      font-size: 12px;
      color: #6B7280;
      margin-top: 4px;
      padding: 0 4px;
    }

    .typing-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: white;
      border-radius: 18px 18px 18px 4px;
      max-width: 80px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid #E5E7EB;
    }

    .typing-indicator.show {
      display: flex;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #6B7280;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }

    .input-container {
      padding: 16px 24px;
      background: white;
      border-top: 1px solid #E5E7EB;
      display: flex;
      align-items: flex-end;
      gap: 12px;
    }

    .input-wrapper {
      flex: 1;
    }

    .input-field {
      width: 100%;
      min-height: 44px;
      max-height: 120px;
      padding: 12px 16px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      color: #111827;
      background: #F9FAFB;
      border: 1px solid #E5E7EB;
      border-radius: 22px;
      resize: none;
      outline: none;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      background: white;
      border-color: #4A90E2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .send-button {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #4A90E2;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .send-button:hover {
      background: #357ABD;
      transform: scale(1.05);
    }

    .send-button:disabled {
      background: #D1D5DB;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .send-button:active:not(:disabled) {
      transform: scale(0.95);
    }

    /* Profile Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      font-size: 20px;
      font-weight: 600;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6B7280;
    }

    .profile-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #E5E7EB;
    }

    .profile-section:last-child {
      border-bottom: none;
    }

    .profile-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: #6B7280;
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    .profile-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .profile-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .profile-label {
      font-size: 14px;
      color: #6B7280;
    }

    .profile-value {
      font-size: 14px;
      font-weight: 500;
      color: #111827;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-free {
      background: #F3F4F6;
      color: #6B7280;
    }

    .badge-premium {
      background: #FEF3C7;
      color: #92400E;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #E5E7EB;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: #4A90E2;
      transition: width 0.3s ease;
    }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 14px;
    }

    .btn-primary {
      background: #4A90E2;
      color: white;
    }

    .btn-primary:hover {
      background: #357ABD;
    }

    .btn-secondary {
      background: #F3F4F6;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #E5E7EB;
    }

    .btn-danger {
      background: #FEE2E2;
      color: #DC2626;
    }

    .btn-danger:hover {
      background: #FECACA;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">Chat History</span>
      <button class="close-sidebar" onclick="toggleSidebar()">√ó</button>
    </div>
    <button class="new-chat-btn" onclick="createNewChat()">+ New Chat</button>
    <div class="chat-list" id="chatList">
      <div class="chat-item active">
        <div class="chat-item-title">Current Chat</div>
        <div class="chat-item-preview">Active conversation</div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="chat-container">
      <!-- Header -->
      <div class="chat-header">
        <button class="menu-button" onclick="toggleSidebar()">‚ò∞</button>
        <div class="chat-header-content">
          <h1>WorkLife Coach</h1>
          <p>Here to help you get unstuck</p>
        </div>
        <button class="menu-button" onclick="openProfile()" title="Profile & Settings">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="8" r="3"/>
            <path d="M6.168 18.849A4 4 0 0 1 10 16h4a4 4 0 0 1 3.834 2.855"/>
          </svg>
        </button>
      </div>

      <!-- Chat Body -->
      <div class="chat-body" id="chatBody">
        <div class="message message-ai">
          <div class="message-content">
            Hi! I'm your WorkLife coach. I'm here to help you get unstuck in your career‚Äîwhether you're figuring out what to learn next, thinking about switching fields, or just feeling lost about where you're headed. Let's talk through it together.
          </div>
          <div class="message-actions">
            <button class="action-btn" onclick="copyMessage(this)">
              üìã Copy
            </button>
          </div>
          <div class="message-timestamp">Just now</div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
      </div>

      <!-- Input Bar -->
      <div class="input-container">
        <div class="input-wrapper">
          <textarea 
            class="input-field" 
            id="messageInput"
            placeholder="Type your message..."
            rows="1"
          ></textarea>
        </div>
        <button class="send-button" id="sendButton" title="Send message">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M2 10L18 2L10 18L8 11L2 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Profile & Settings</h2>
        <button class="close-modal" onclick="closeProfile()">√ó</button>
      </div>

      <div class="profile-section">
        <h3>Account</h3>
        <div class="profile-info">
          <div class="profile-row">
            <span class="profile-label">Email</span>
            <span class="profile-value" id="userEmail">guest@worklife.ai</span>
          </div>
          <div class="profile-row">
            <span class="profile-label">Plan</span>
            <span class="badge badge-free" id="userPlan">Free</span>
          </div>
        </div>
      </div>

      <div class="profile-section">
        <h3>Usage</h3>
        <div class="profile-info">
          <div class="profile-row">
            <span class="profile-label">Messages Used</span>
            <span class="profile-value" id="messageCount">0 / 10</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="profile-section">
        <h3>Actions</h3>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button class="btn btn-primary" onclick="goToUpgrade()">
            ‚≠ê Upgrade to Premium
          </button>
          <button class="btn btn-secondary" onclick="goToAuth()">
            üîê Login / Sign Up
          </button>
          <button class="btn btn-danger" onclick="logout()">
            üö™ Logout
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const chatBody = document.getElementById('chatBody');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');

    // API Configuration
    const API_BASE = 'http://localhost:3000';
    let sessionId = null;
    let userId = null;

    // Initialize session
    async function initializeSession() {
      try {
        console.log('üîÑ Initializing session...');
        const response = await fetch(`${API_BASE}/api/chat/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: localStorage.getItem('userId') || null })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        sessionId = data.sessionId;
        userId = data.userId;
        localStorage.setItem('userId', userId);
        
        console.log('‚úÖ Session initialized:', sessionId);
      } catch (error) {
        console.error('‚ùå Failed to initialize session:', error);
      }
    }

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });

    // Send on Enter
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Send button click
    sendButton.addEventListener('click', sendMessage);

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      console.log('üì§ Sending:', message);
      sendButton.disabled = true;

      if (!sessionId) {
        await initializeSession();
        if (!sessionId) {
          alert('Could not connect to server');
          sendButton.disabled = false;
          return;
        }
      }

      addMessage(message, 'user');
      messageInput.value = '';
      messageInput.style.height = 'auto';

      typingIndicator.classList.add('show');
      scrollToBottom();

      try {
        const response = await fetch(`${API_BASE}/api/chat/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, message })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        console.log('‚úÖ Response:', data);
        
        typingIndicator.classList.remove('show');
        addMessage(data.message, 'ai');
        
        // Track message count
        incrementMessageCount();
      } catch (error) {
        console.error('‚ùå Error:', error);
        typingIndicator.classList.remove('show');
        addMessage('Sorry, I couldn\'t connect to the server.', 'ai');
      } finally {
        sendButton.disabled = false;
        messageInput.focus();
      }
    }

    function addMessage(content, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message message-${type}`;
      
      const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      const formattedContent = content.replace(/\n/g, '<br>');
      
      messageDiv.innerHTML = `
        <div class="message-content">${formattedContent}</div>
        <div class="message-actions">
          <button class="action-btn" onclick="copyMessage(this)">üìã Copy</button>
          ${type === 'user' ? '<button class="action-btn" onclick="editMessage(this)">‚úèÔ∏è Edit</button>' : ''}
        </div>
        <div class="message-timestamp">${time}</div>
      `;
      
      chatBody.insertBefore(messageDiv, typingIndicator);
      scrollToBottom();
    }

    function copyMessage(btn) {
      const messageContent = btn.closest('.message').querySelector('.message-content').innerText;
      navigator.clipboard.writeText(messageContent).then(() => {
        btn.innerHTML = '‚úÖ Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.innerHTML = 'üìã Copy';
          btn.classList.remove('copied');
        }, 2000);
      });
    }

    function editMessage(btn) {
      const messageContent = btn.closest('.message').querySelector('.message-content').innerText;
      messageInput.value = messageContent;
      messageInput.focus();
      messageInput.style.height = 'auto';
      messageInput.style.height = messageInput.scrollHeight + 'px';
    }

    function scrollToBottom() {
      chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: 'smooth' });
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('mainContent').classList.toggle('sidebar-open');
    }

    function createNewChat() {
      console.log('Creating new chat...');
      
      // Remove all messages except typing indicator
      const messages = chatBody.querySelectorAll('.message');
      messages.forEach(msg => msg.remove());
      
      // Ensure typing indicator exists
      if (!document.getElementById('typingIndicator')) {
        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.id = 'typingIndicator';
        indicator.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
        chatBody.appendChild(indicator);
      }
      
      // Add welcome message
      addMessage("Hi! I'm your WorkLife coach. How can I help you today?", 'ai');
      
      // Reset session
      sessionId = null;
      initializeSession();
      
      // Update chat list
      const chatList = document.getElementById('chatList');
      chatList.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
      
      const newChat = document.createElement('div');
      newChat.className = 'chat-item active';
      newChat.innerHTML = '<div class="chat-item-title">New Conversation</div><div class="chat-item-preview">Just started...</div>';
      chatList.insertBefore(newChat, chatList.firstChild);
      
      if (window.innerWidth < 768) toggleSidebar();
      messageInput.focus();
      
      console.log('‚úÖ New chat created');
    }

    // Profile Management
    function openProfile() {
      updateProfileDisplay();
      document.getElementById('profileModal').classList.add('show');
    }

    function closeProfile() {
      document.getElementById('profileModal').classList.remove('show');
    }

    function updateProfileDisplay() {
      const user = localStorage.getItem('user');
      const messageCount = parseInt(localStorage.getItem('messageCount') || '0');
      
      if (user) {
        try {
          const userData = JSON.parse(user);
          document.getElementById('userEmail').textContent = userData.email || 'user@worklife.ai';
          
          if (userData.isPremium) {
            document.getElementById('userPlan').textContent = 'Premium ‚≠ê';
            document.getElementById('userPlan').className = 'badge badge-premium';
            document.getElementById('messageCount').textContent = `${messageCount} messages`;
            document.getElementById('progressFill').style.width = '100%';
          } else {
            document.getElementById('userPlan').textContent = 'Free';
            document.getElementById('userPlan').className = 'badge badge-free';
            document.getElementById('messageCount').textContent = `${messageCount} / 10`;
            document.getElementById('progressFill').style.width = `${(messageCount / 10) * 100}%`;
          }
        } catch (error) {
          console.error('Error parsing user data:', error);
        }
      } else {
        document.getElementById('userEmail').textContent = 'Guest Mode';
        document.getElementById('userPlan').textContent = 'Free';
        document.getElementById('messageCount').textContent = `${messageCount} / 10`;
        document.getElementById('progressFill').style.width = `${(messageCount / 10) * 100}%`;
      }
    }

    function goToUpgrade() {
      window.location.href = '/upgrade.html';
    }

    function goToAuth() {
      window.location.href = '/auth.html';
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('user');
        localStorage.removeItem('userId');
        localStorage.removeItem('messageCount');
        window.location.href = '/auth.html';
      }
    }

    // Track message count
    function incrementMessageCount() {
      const user = localStorage.getItem('user');
      let messageCount = parseInt(localStorage.getItem('messageCount') || '0');
      messageCount++;
      localStorage.setItem('messageCount', messageCount.toString());

      // Check if user needs to upgrade
      if (user) {
        try {
          const userData = JSON.parse(user);
          if (!userData.isPremium && messageCount >= 10) {
            alert('You\'ve reached your free message limit! Upgrade to Premium for unlimited messages.');
            window.location.href = '/upgrade.html';
          }
        } catch (error) {
          console.error('Error checking subscription:', error);
        }
      } else {
        // Guest mode
        if (messageCount >= 10) {
          alert('You\'ve reached your free message limit! Sign up for more messages.');
          window.location.href = '/auth.html';
        }
      }
    }

    // Close modal when clicking outside
    document.getElementById('profileModal').addEventListener('click', (e) => {
      if (e.target.id === 'profileModal') {
        closeProfile();
      }
    });

    // Initialize
    initializeSession();
    scrollToBottom();
    messageInput.focus();
    updateProfileDisplay();

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('‚úÖ Service Worker registered:', registration);
          })
          .catch((error) => {
            console.log('‚ùå Service Worker registration failed:', error);
          });
      });
    }

    // Install prompt for PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('üí° App can be installed!');
    });
  </script>
</body>
</html>
