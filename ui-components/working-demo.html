<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WorkLife AI Coach - Working Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #FAFAFA;
      min-height: 100vh;
      display: flex;
      padding: 0;
      margin: 0;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid #E5E7EB;
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 100;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #E5E7EB;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-title {
      font-weight: 600;
      font-size: 16px;
      color: #111827;
    }

    .close-sidebar {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6B7280;
      padding: 4px;
    }

    .new-chat-btn {
      margin: 16px;
      padding: 12px;
      background: #111827;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    .new-chat-btn:hover {
      background: #1F2937;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .chat-item {
      padding: 12px 16px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .chat-item:hover {
      background: #F9FAFB;
    }

    .chat-item.active {
      background: #F3F4F6;
    }

    .chat-item-title {
      font-size: 14px;
      font-weight: 500;
      color: #111827;
      margin-bottom: 4px;
    }

    .chat-item-preview {
      font-size: 12px;
      color: #6B7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      margin-left: 0;
      transition: margin-left 0.3s ease;
    }

    .main-content.sidebar-open {
      margin-left: 280px;
    }

    .chat-container {
      width: 100%;
      max-width: 800px;
      height: 90vh;
      max-height: 900px;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      border: 1px solid #E5E7EB;
    }

    .chat-header {
      padding: 20px 24px;
      background: white;
      border-bottom: 1px solid #E5E7EB;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .menu-button {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #374151;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .menu-button:hover {
      background: #F3F4F6;
    }

    .chat-header-content h1 {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }

    .chat-header-content p {
      font-size: 14px;
      color: #6B7280;
    }

    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: white;
    }

    .message {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-user {
      align-items: flex-end;
    }

    .message-ai {
      align-items: flex-start;
    }

    .message-content {
      padding: 12px 16px;
      font-size: 16px;
      max-width: 70%;
      word-wrap: break-word;
      line-height: 1.5;
    }

    .message-user .message-content {
      background: #1A1A1A;
      color: white;
      border-radius: 16px 16px 4px 16px;
    }

    .message-ai .message-content {
      background: #F3F4F6;
      color: #111827;
      border-radius: 16px 16px 16px 4px;
      border: 1px solid #E5E7EB;
      max-width: 75%;
    }

    .message-timestamp {
      font-size: 12px;
      color: #6B7280;
      margin-top: 4px;
      padding: 0 4px;
    }

    .typing-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: white;
      border-radius: 18px 18px 18px 4px;
      max-width: 80px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid #E5E7EB;
    }

    .typing-indicator.show {
      display: flex;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #6B7280;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }

    .input-container {
      padding: 16px 24px;
      background: white;
      border-top: 1px solid #E5E7EB;
      display: flex;
      align-items: flex-end;
      gap: 12px;
    }

    .input-wrapper {
      flex: 1;
    }

    .input-field {
      width: 100%;
      min-height: 44px;
      max-height: 120px;
      padding: 12px 16px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      color: #111827;
      background: #F9FAFB;
      border: 1px solid #E5E7EB;
      border-radius: 22px;
      resize: none;
      outline: none;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      background: white;
      border-color: #4A90E2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .send-button {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #4A90E2;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .send-button:hover {
      background: #357ABD;
      transform: scale(1.05);
    }

    .send-button:disabled {
      background: #D1D5DB;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .send-button:active:not(:disabled) {
      transform: scale(0.95);
    }

    .status-bar {
      padding: 8px 24px;
      background: #F3F4F6;
      border-bottom: 1px solid #E5E7EB;
      font-size: 12px;
      color: #6B7280;
    }

    .status-bar.connected {
      background: #ECFDF5;
      color: #059669;
    }

    .status-bar.error {
      background: #FEF2F2;
      color: #DC2626;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">Chat History</span>
      <button class="close-sidebar" onclick="toggleSidebar()">√ó</button>
    </div>
    <button class="new-chat-btn" onclick="createNewChat()">+ New Chat</button>
    <div class="chat-list" id="chatList">
      <div class="chat-item active">
        <div class="chat-item-title">Current Chat</div>
        <div class="chat-item-preview">Active conversation</div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="chat-container">
    <!-- Status Bar -->
    <div class="status-bar" id="statusBar">Connecting to server...</div>

    <!-- Header -->
    <div class="chat-header">
      <button class="menu-button" onclick="toggleSidebar()">‚ò∞</button>
      <div class="chat-header-content">
        <h1>WorkLife Coach</h1>
        <p>Here to help you get unstuck</p>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="chat-body" id="chatBody">
      <div class="message message-ai">
        <div class="message-content">
          Hi! I'm your WorkLife coach. I'm here to help you get unstuck in your career‚Äîwhether you're figuring out what to learn next, thinking about switching fields, or just feeling lost about where you're headed. Let's talk through it together.
        </div>
        <div class="message-timestamp">Just now</div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" id="typingIndicator">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    </div>

    <!-- Input Bar -->
    <div class="input-container">
      <div class="input-wrapper">
        <textarea 
          class="input-field" 
          id="messageInput"
          placeholder="Type your message..."
          rows="1"
        ></textarea>
      </div>
      <button class="send-button" id="sendButton" title="Send message">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M2 10L18 2L10 18L8 11L2 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="currentColor"/>
        </svg>
      </button>
    </div>
  </div>
  </div>

  <script>
    // Elements
    const chatBody = document.getElementById('chatBody');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const statusBar = document.getElementById('statusBar');

    // API Configuration
    const API_BASE = 'http://localhost:3000';
    let sessionId = null;
    let userId = null;

    // Initialize session on page load
    async function initializeSession() {
      try {
        console.log('üîÑ Initializing session...');
        statusBar.textContent = 'Connecting to server...';
        statusBar.className = 'status-bar';
        
        const response = await fetch(`${API_BASE}/api/chat/start`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: localStorage.getItem('userId') || null
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        sessionId = data.sessionId;
        userId = data.userId;
        localStorage.setItem('userId', userId);
        
        console.log('‚úÖ Session initialized:', sessionId);
        statusBar.textContent = `Connected ‚Ä¢ Session: ${sessionId.substring(0, 20)}...`;
        statusBar.className = 'status-bar connected';
      } catch (error) {
        console.error('‚ùå Failed to initialize session:', error);
        statusBar.textContent = `Error: Could not connect to server. Make sure it's running at ${API_BASE}`;
        statusBar.className = 'status-bar error';
      }
    }

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });

    // Send on Enter (Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Send button click
    sendButton.addEventListener('click', sendMessage);

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) {
        console.log('‚ö†Ô∏è Empty message, not sending');
        return;
      }

      console.log('üì§ Sending message:', message);

      // Disable send button
      sendButton.disabled = true;

      // Check if session is initialized
      if (!sessionId) {
        console.log('‚ö†Ô∏è No session ID, initializing...');
        await initializeSession();
        if (!sessionId) {
          alert('‚ö†Ô∏è Could not connect to server. Please refresh the page and try again.');
          sendButton.disabled = false;
          return;
        }
      }

      // Add user message
      addMessage(message, 'user');
      messageInput.value = '';
      messageInput.style.height = 'auto';

      // Show typing indicator
      typingIndicator.classList.add('show');
      scrollToBottom();

      try {
        // Send to API
        console.log('üîÑ Sending to API:', `${API_BASE}/api/chat/message`);
        const response = await fetch(`${API_BASE}/api/chat/message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sessionId,
            message
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('‚úÖ Received response:', data);
        
        // Hide typing indicator and show response
        typingIndicator.classList.remove('show');
        addMessage(data.message, 'ai');
      } catch (error) {
        console.error('‚ùå Error sending message:', error);
        
        // Fallback response
        typingIndicator.classList.remove('show');
        addMessage('‚ö†Ô∏è Sorry, I couldn\'t connect to the server. Please make sure the server is running and try again.', 'ai');
      } finally {
        // Re-enable send button
        sendButton.disabled = false;
        messageInput.focus();
      }
    }

    function addMessage(content, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message message-${type}`;
      
      const now = new Date();
      const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      
      // Convert line breaks to <br> tags
      const formattedContent = content.replace(/\n/g, '<br>');
      
      messageDiv.innerHTML = `
        <div class="message-content">${formattedContent}</div>
        <div class="message-timestamp">${time}</div>
      `;
      
      // Make sure typing indicator exists
      const indicator = document.getElementById('typingIndicator');
      if (indicator) {
        chatBody.insertBefore(messageDiv, indicator);
      } else {
        console.warn('Typing indicator not found, appending message to end');
        chatBody.appendChild(messageDiv);
      }
      
      scrollToBottom();
    }

    function scrollToBottom() {
      chatBody.scrollTo({
        top: chatBody.scrollHeight,
        behavior: 'smooth'
      });
    }

    // Sidebar functions
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      sidebar.classList.toggle('open');
      mainContent.classList.toggle('sidebar-open');
    }

    function createNewChat() {
      console.log('Creating new chat...');
      
      // Clear only message elements, keep typing indicator
      const messages = chatBody.querySelectorAll('.message');
      messages.forEach(msg => msg.remove());
      
      // Make sure typing indicator exists and is hidden
      let indicator = document.getElementById('typingIndicator');
      if (!indicator) {
        // Recreate typing indicator if it was removed
        indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.id = 'typingIndicator';
        indicator.innerHTML = `
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        `;
        chatBody.appendChild(indicator);
      }
      indicator.classList.remove('show');
      
      // Add welcome message
      addMessage("Hi! I'm your WorkLife coach. How can I help you today?", 'ai');
      
      // Reset and initialize a new session
      sessionId = null;
      initializeSession();
      
      // Update chat list
      const chatList = document.getElementById('chatList');
      const newChat = document.createElement('div');
      newChat.className = 'chat-item active';
      newChat.innerHTML = `
        <div class="chat-item-title">New Conversation</div>
        <div class="chat-item-preview">Just started...</div>
      `;
      
      // Remove active from all items
      chatList.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
      
      // Add new chat to top
      chatList.insertBefore(newChat, chatList.firstChild);
      
      // Close sidebar on mobile
      if (window.innerWidth < 768) {
        toggleSidebar();
      }
      
      // Focus input
      messageInput.focus();
      
      console.log('New chat created, session reset');
    }

    // Initialize session when page loads
    initializeSession();

    // Initial scroll
    scrollToBottom();

    // Focus input on load
    messageInput.focus();
  </script>
</body>
</html>
